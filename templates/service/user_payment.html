{% extends 'base.html' %}
{% load static %}

{% block title %}Payment - Service #{{ service_request.id }}{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Service Payment</h4>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>Service Details</h5>
                            <p class="mb-1"><strong>Service ID:</strong> #{{ service_request.id }}</p>
                            <p class="mb-1"><strong>Mechanic:</strong> {{ service_request.mechanic.user.get_full_name }}</p>
                            <p class="mb-1"><strong>Vehicle:</strong> {{ service_request.vehicle.name }}</p>
                            <p class="mb-1"><strong>Issue:</strong> {{ service_request.issue_description|truncatechars:100 }}</p>
                        </div>
                        <div class="col-md-6">
                            <h5>Payment Summary</h5>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <tr>
                                        <td>Service Charge:</td>
                                        <td class="text-end">₹{{ payment.service_charge }}</td>
                                    </tr>
                                    <tr>
                                        <td>Tax (18% GST):</td>
                                        <td class="text-end">₹{{ payment.tax }}</td>
                                    </tr>
                                    <tr class="fw-bold">
                                        <td>Total Amount:</td>
                                        <td class="text-end">₹{{ payment.total_amount }}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>

                    {% if payment.payment_status == 'PENDING' %}
                    <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
                        {% csrf_token %}
                        <div class="mb-4">
                            <h5>Select Payment Method</h5>
                            <div class="row g-3">
                                <div class="col-6 col-md-3">
                                    <div class="form-check payment-method-card">
                                        <input class="form-check-input" type="radio" name="payment_method" id="cash" value="CASH" required>
                                        <label class="form-check-label" for="cash">
                                            <i class="fas fa-money-bill-wave fa-2x mb-2"></i>
                                            <span>Cash</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="form-check payment-method-card">
                                        <input class="form-check-input" type="radio" name="payment_method" id="upi" value="UPI" required>
                                        <label class="form-check-label" for="upi">
                                            <i class="fas fa-qrcode fa-2x mb-2"></i>
                                            <span>UPI</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="form-check payment-method-card">
                                        <input class="form-check-input" type="radio" name="payment_method" id="card" value="CARD" required>
                                        <label class="form-check-label" for="card">
                                            <i class="fas fa-credit-card fa-2x mb-2"></i>
                                            <span>Card</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="form-check payment-method-card">
                                        <input class="form-check-input" type="radio" name="payment_method" id="netbanking" value="NET_BANKING" required>
                                        <label class="form-check-label" for="netbanking">
                                            <i class="fas fa-university fa-2x mb-2"></i>
                                            <span>Net Banking</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="onlinePaymentFields" class="mb-4" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="transaction_id" class="form-label">Transaction ID</label>
                                        <input type="text" class="form-control" id="transaction_id" name="transaction_id">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="payment_proof" class="form-label">Payment Screenshot</label>
                                        <input type="file" class="form-control" id="payment_proof" name="payment_proof" accept="image/*">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-end">
                            <button type="submit" class="btn btn-primary">Submit Payment</button>
                        </div>
                    </form>
                    {% else %}
                    <div class="alert alert-info">
                        <h5>Payment Status: {{ payment.get_payment_status_display }}</h5>
                        <p class="mb-0">
                            {% if payment.payment_method %}
                            Payment Method: {{ payment.get_payment_method_display }}<br>
                            {% endif %}
                            {% if payment.transaction_id %}
                            Transaction ID: {{ payment.transaction_id }}<br>
                            {% endif %}
                            {% if payment.paid_at %}
                            Paid on: {{ payment.paid_at|date:"M d, Y H:i" }}
                            {% endif %}
                        </p>
                        {% if payment.payment_status == 'PAID' %}
                        <div class="mt-3">
                            <a href="{% url 'payment_receipt' payment.id %}" class="btn btn-success">
                                <i class="fas fa-file-invoice me-2"></i>View Receipt
                            </a>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.payment-method-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
    height: 100%;
    cursor: pointer;
    transition: all 0.2s;
}

.payment-method-card:hover {
    border-color: #3b82f6;
    background-color: #f8fafc;
}

.payment-method-card .form-check-input {
    display: none;
}

.payment-method-card label {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    margin: 0;
    width: 100%;
    height: 100%;
}

.payment-method-card input[type="radio"]:checked + label {
    color: #3b82f6;
}

.payment-method-card input[type="radio"]:checked + label i {
    color: #3b82f6;
}

.payment-method-card:has(input[type="radio"]:checked) {
    border-color: #3b82f6;
    background-color: #eff6ff;
}
</style>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const paymentMethods = document.querySelectorAll('input[name="payment_method"]');
    const onlinePaymentFields = document.getElementById('onlinePaymentFields');

    paymentMethods.forEach(method => {
        method.addEventListener('change', function() {
            if (this.value === 'CASH') {
                onlinePaymentFields.style.display = 'none';
            } else {
                onlinePaymentFields.style.display = 'block';
            }
        });
    });
});
</script>
{% endblock %}
{% endblock %} 