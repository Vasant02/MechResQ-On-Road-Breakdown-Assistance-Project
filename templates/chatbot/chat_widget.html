<style>
    .chat-container {
        position: fixed;
        bottom: 32px;
        right: 32px;
        width: clamp(280px, 28vw, 360px);
        height: 480px;
        background-color: var(--background-medium);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-lg);
        box-shadow: 0 20px 40px rgba(15, 23, 20, 0.22);
        display: flex;
        flex-direction: column;
        font-family: var(--font-family-sans-serif);
        z-index: 1050;
        overflow: hidden;
        backdrop-filter: blur(6px);
    }
    .chat-message ul {
        padding-left: 1.25rem;
        margin: 0.35rem 0 0;
    }
    .chat-message li {
        margin-bottom: 0.25rem;
    }
    .chat-message h6 {
        font-size: 0.85rem;
        margin: 0.35rem 0;
        color: var(--text-dark);
    }
    .chat-header {
        background: var(--primary-color);
        color: #fff;
        padding: var(--spacing-md);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .chat-header h4 {
        margin: 0;
        font-size: 1rem;
        letter-spacing: 0.5px;
    }
    .chat-status {
        font-size: 0.75rem;
        opacity: 0.8;
    }
    .chat-body {
        flex: 1;
        padding: var(--spacing-md);
        overflow-y: auto;
        background: var(--background-dark);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
    }
    .chat-message {
        padding: 0.65rem 0.9rem;
        border-radius: 16px;
        max-width: 85%;
        line-height: 1.4;
        font-size: 0.92rem;
        letter-spacing: 0.01em;
        box-shadow: 0 5px 15px rgba(15, 23, 20, 0.08);
    }
    .chat-message.user {
        background: var(--primary-color);
        color: #fff;
        align-self: flex-end;
        border-bottom-right-radius: 6px;
    }
    .chat-message.ai {
        background: var(--background-medium);
        color: var(--text-light);
        align-self: flex-start;
        border-bottom-left-radius: 6px;
        border: 1px solid rgba(122, 172, 106, 0.25);
    }
    .chat-input-area {
        display: flex;
        align-items: center;
        padding: var(--spacing-sm) var(--spacing-md);
        gap: var(--spacing-sm);
        border-top: 1px solid var(--border-color);
        background: var(--background-medium);
    }
    .chat-input-area input {
        flex: 1;
        border-radius: 999px;
        border: 1px solid var(--border-color);
        padding: 0.65rem 1rem;
        font-size: 0.92rem;
        background: var(--background-dark);
        color: var(--text-light);
    }
    .chat-input-area button {
        border-radius: 999px;
        padding: 0.55rem 1.1rem;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    #sendChatButton {
        background: var(--primary-color);
        color: #fff;
        box-shadow: 0 10px 20px rgba(120, 195, 87, 0.25);
    }
    #sendChatButton:hover {
        transform: translateY(-1px);
    }
    .attachment-button {
        background: transparent;
        color: var(--text-dark);
        font-size: 1.3rem;
        border: none;
        padding: 0.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .attachment-button:hover {
        color: var(--primary-color);
    }
    .attachment-dropdown {
        position: absolute;
        bottom: 70px;
        left: 18px;
        background: var(--background-medium);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-md);
        box-shadow: 0 12px 30px rgba(15, 23, 20, 0.12);
        padding: var(--spacing-sm) 0;
        z-index: 1100;
        min-width: 210px;
    }
    .attachment-dropdown-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-md);
        cursor: pointer;
        font-size: 0.9rem;
        color: var(--text-light);
    }
    .attachment-dropdown-item:hover {
        background: var(--background-light);
    }
    .attachment-dropdown-item i {
        color: var(--primary-color);
    }
    .chat-toggle-button {
        position: fixed;
        bottom: 32px;
        right: 32px;
        background: var(--primary-color);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 64px;
        height: 64px;
        font-size: 1.35rem;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        box-shadow: 0 20px 35px rgba(120, 195, 87, 0.35);
        z-index: 1040;
        transition: transform 0.2s ease;
    }
    .chat-toggle-button:hover {
        transform: translateY(-2px);
    }
    .hidden {
        display: none;
    }
</style>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<button class="chat-toggle-button" id="chatToggleButton">ðŸ’¬</button>

<div class="chat-container hidden" id="chatContainer">
    <div class="chat-header">
        <div>
            <h4>ResQAssist</h4>
            <span class="chat-status" id="chatStatus">Ready to help</span>
        </div>
        <button id="closeChatButton" class="attachment-button" aria-label="Close chatbot">&times;</button>
    </div>
    <div class="chat-body" id="chatBody">
        <!-- Chat messages will be appended here -->
        <div class="chat-message ai">Hi! Ask about your service requests, mechanics, or payments.</div>
    </div>
    <div class="chat-input-area">
        <button class="attachment-button" id="attachmentButton">âž•</button>
        <input type="text" id="chatInput" placeholder="Type your message...">
        <button id="sendChatButton">Send</button>

        <div class="attachment-dropdown hidden" id="attachmentDropdown">
            <div class="attachment-dropdown-item" id="addPhotosFiles">
                <i class="fas fa-paperclip"></i> Add photos & files
            </div>
            <input type="file" id="fileInput" multiple class="hidden">
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatToggleButton = document.getElementById('chatToggleButton');
        const chatContainer = document.getElementById('chatContainer');
        const closeChatButton = document.getElementById('closeChatButton');
        const chatInput = document.getElementById('chatInput');
        const sendChatButton = document.getElementById('sendChatButton');
        const chatBody = document.getElementById('chatBody');
        const attachmentButton = document.getElementById('attachmentButton');
        const attachmentDropdown = document.getElementById('attachmentDropdown');
        const addPhotosFiles = document.getElementById('addPhotosFiles');
        const fileInput = document.getElementById('fileInput');
        const chatStatus = document.getElementById('chatStatus');

        let isChatOpen = false;

        function toggleChat() {
            isChatOpen = !isChatOpen;
            const sosButton = document.getElementById('sosButton'); // Get the SOS button

            if (isChatOpen) {
                chatContainer.classList.remove('hidden');
                chatToggleButton.classList.add('hidden');
                if (sosButton) {
                    sosButton.style.display = 'none'; // Hide SOS button when chat is open
                }
            } else {
                chatContainer.classList.add('hidden');
                chatToggleButton.classList.remove('hidden');
                if (sosButton) {
                    sosButton.style.display = 'flex'; // Show SOS button when chat is closed (using flex as per its original style)
                }
                attachmentDropdown.classList.add('hidden'); // Hide dropdown when chat closes
            }
        }

        chatToggleButton.addEventListener('click', toggleChat);
        closeChatButton.addEventListener('click', function(event) {
            event.stopPropagation(); // Prevent the click from bubbling up to the chatHeader
            toggleChat();
        });

        sendChatButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        function hydrateHistory() {
            fetch('/chatbot/history/?limit=12', {
                credentials: 'same-origin'
            })
                .then((resp) => resp.json())
                .then((data) => {
                    if (!data.history) return;
                    chatBody.innerHTML = '';
                    data.history.forEach(entry => {
                        appendMessage(entry.message, 'user');
                        appendMessage(entry.response, 'ai');
                    });
                })
                .catch(() => {
                    appendMessage('Unable to load previous messages.', 'ai');
                });
        }

        hydrateHistory();

        attachmentButton.addEventListener('click', function(event) {
            event.stopPropagation(); // Prevent click from closing dropdown immediately
            attachmentDropdown.classList.toggle('hidden');
        });

        addPhotosFiles.addEventListener('click', function() {
            fileInput.click(); // Trigger the hidden file input
            attachmentDropdown.classList.add('hidden'); // Hide dropdown after selection
        });

        fileInput.addEventListener('change', function(event) {
            const files = event.target.files;
            if (files.length > 0) {
                // For now, just log the file names. Actual upload logic would go here.
                let fileNames = [];
                for (let i = 0; i < files.length; i++) {
                    fileNames.push(files[i].name);
                }
                appendMessage(`Attached: ${fileNames.join(', ')}`, 'user');
                // You would typically send these files to the server here
                // sendFilesToChatbot(files);
            }
        });

        // Close dropdown if clicked outside
        document.addEventListener('click', function(event) {
            if (!attachmentDropdown.contains(event.target) && !attachmentButton.contains(event.target)) {
                attachmentDropdown.classList.add('hidden');
            }
        });


        function sendMessage() {
            const message = chatInput.value.trim();
            if (message) {
                appendMessage(message, 'user');
                chatInput.value = '';
                sendToChatbot(message);
            }
        }

        function appendMessage(message, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message', sender);
            messageElement.innerHTML = formatMessage(message);
            chatBody.appendChild(messageElement);
            chatBody.scrollTop = chatBody.scrollHeight; // Scroll to bottom
        }

        function formatMessage(text) {
            if (!text) return '';

            const escapeHtml = (str) => str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            const formatInline = (str) =>
                escapeHtml(str).replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

            const lines = text.split(/\n+/).map(line => line.trim()).filter(Boolean);
            let html = '';
            let inList = false;

            const closeList = () => {
                if (inList) {
                    html += '</ul>';
                    inList = false;
                }
            };

            lines.forEach(line => {
                if (/^-\s+/.test(line)) {
                    if (!inList) {
                        html += '<ul class="chat-list">';
                        inList = true;
                    }
                    const itemText = line.replace(/^-\s+/, '');
                    html += `<li>${formatInline(itemText)}</li>`;
                    return;
                }

                closeList();

                if (/^#{1,3}\s+/.test(line)) {
                    const heading = line.replace(/^#{1,3}\s+/, '');
                    html += `<h6>${formatInline(heading)}</h6>`;
                } else {
                    html += `<p>${formatInline(line)}</p>`;
                }
            });

            closeList();
            return html;
        }

        function sendToChatbot(message) {
            // Display a loading indicator or "typing..." message
            const loadingMessage = document.createElement('div');
            loadingMessage.classList.add('chat-message', 'ai');
            loadingMessage.textContent = 'Typingâ€¦';
            loadingMessage.id = 'loadingMessage';
            chatBody.appendChild(loadingMessage);
            chatBody.scrollTop = chatBody.scrollHeight;
            chatStatus.textContent = 'Respondingâ€¦';

            fetch('/chatbot/response/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ message: message }),
                credentials: 'same-origin' // Ensure cookies are sent
            })
            .then(response => {
                if (!response.ok) {
                    // Try to parse error from JSON response
                    return response.json().then(err => {
                        throw new Error(err.error || `HTTP error! Status: ${response.status}`);
                    }).catch(() => {
                        // Fallback for non-JSON responses
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                const loadingElem = document.getElementById('loadingMessage');
                if (loadingElem) loadingElem.remove();

                chatStatus.textContent = 'Ready to help';
                if (data.response) {
                    appendMessage(data.response, 'ai');
                } else if (data.error) {
                    appendMessage(`Error: ${data.error}`, 'ai');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                const loadingElem = document.getElementById('loadingMessage');
                if (loadingElem) loadingElem.remove();
                chatStatus.textContent = 'Temporarily unavailable';
                appendMessage(error.message || 'Sorry, something went wrong. Please try again.', 'ai');
            });
        }

        // Function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
